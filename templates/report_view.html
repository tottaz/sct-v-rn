{% extends "base.html" %}
{% block content %}
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <h2>Scan Report</h2>
      <p class="text-muted">Target: <strong>{{ config.target }}</strong></p>

      <div class="mb-4">
        <h3>Summary</h3>
        <ul>
          <li>Started: {{ report.meta.started }}</li>
          <li>Endpoints discovered: {{ report.endpoints | length }}</li>
        </ul>
      </div>

      <div class="mb-4">
        <h3>Security Headers</h3>
        <ul class="list-group">
          {% for i in report.headers %}
            <li class="list-group-item list-group-item-light">{{ i }}</li>
          {% endfor %}
        </ul>
      </div>

      <div class="mb-4">
        <h3>SSL</h3>
        <ul class="list-group">
          {% for i in report.ssl %}
            <li class="list-group-item list-group-item-info">{{ i }}</li>
          {% endfor %}
        </ul>
      </div>

      <div class="mb-4">
        <h3>Open Ports</h3>
        <ul class="list-group">
          {% for p, open in report.ports %}
            <li class="list-group-item {% if open %}list-group-item-success{% else %}list-group-item-secondary{% endif %}">
              {{ p }} â€” {% if open %}OPEN{% else %}closed{% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>

      <div class="mb-4">
        <h3>Endpoints</h3>
        <ul class="list-group">
          {% for e in report.endpoints %}
            <li class="list-group-item">{{ e }}</li>
          {% endfor %}
        </ul>
      </div>

      <div class="row">
        <div class="col-md-6 mb-4">
          <h4 style="color:red">XSS Findings</h4>
          <ul class="list-group">
            {% for x in report.xss %}
              <li class="list-group-item list-group-item-danger">{{ x }}</li>
            {% endfor %}
          </ul>
        </div>

        <div class="col-md-6 mb-4">
          <h4 style="color:orange">SQLi Findings</h4>
          <ul class="list-group">
            {% for s in report.sqli %}
              <li class="list-group-item list-group-item-warning">{{ s }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <div class="mb-4">
        <h4 style="color:goldenrod">CSRF Missing Tokens</h4>
        <ul class="list-group">
          {% for c in report.csrf %}
            <li class="list-group-item list-group-item-warning">{{ c }}</li>
          {% endfor %}
        </ul>
      </div>

      <div class="mb-4">
        <h4 style="color:green">Form Fuzz Results</h4>
        <ul class="list-group">
          {% for f in report.form_fuzz %}
            <li class="list-group-item list-group-item-success">{{ f }}</li>
          {% endfor %}
        </ul>
      </div>

      <div class="d-flex gap-2">
        <a class="btn btn-primary" href="{{ url_for('reports_list') }}">Back to Reports</a>
        <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">Run another scan</a>
        <button class="btn btn-info" id="compareBtn">Compare Reports</button>
        <button class="btn btn-warning" id="askAiBtn">Chat with AI</button>
        <a href="{{ url_for('ask_ui') }}" class="btn btn-primary">Ask AI About Report</a>
      </div>

    </div>
  </div>

  <!-- Modal for AI Question -->
<div class="modal fade" id="askAiModal" tabindex="-1" aria-labelledby="askAiLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="askAiForm">
        <div class="modal-header">
          <h5 class="modal-title" id="askAiLabel">Ask AI about this report</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <textarea class="form-control" name="question" placeholder="Enter your question here..." required></textarea>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Ask</button>
        </div>
      </form>
      <div class="p-3" id="aiAnswer" style="white-space:pre-wrap;"></div>
    </div>
  </div>
</div>

<script>
  document.getElementById("askAiBtn").addEventListener("click", () => {
    var modal = new bootstrap.Modal(document.getElementById('askAiModal'))
    modal.show()
  })

  document.getElementById("askAiForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const question = e.target.question.value;
    const responseDiv = document.getElementById("aiAnswer");
    responseDiv.innerHTML = "Thinking...";
    const resp = await fetch("/ask", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({question})
    });
    const data = await resp.json();
    responseDiv.innerHTML = data.answer || "No response";
  })
</script>
{% endblock %}
